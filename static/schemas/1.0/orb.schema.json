{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://openroadbook.com/schemas/1.0/orb.schema.json",
  "title": "OpenRoadBook Adventure Schema",
  "type": "object",
  "required": ["meta", "stages"],
  "additionalProperties": false,
  "properties": {
    "meta": {
      "type": "object",
      "required": ["openroadbook", "profile", "id", "title"],
      "additionalProperties": true,
      "properties": {
        "openroadbook": {
          "description": "Schema version number for OpenRoadBook documents.",
          "type": ["number", "string"]
        },
        "profile": {
          "description": "Declared profile (e.g., adventure, fia).",
          "type": "string",
          "minLength": 1
        },
        "id": {
          "description": "Document identifier.",
          "type": "string",
          "minLength": 1
        },
        "title": {
          "description": "Human readable title.",
          "type": "string",
          "minLength": 1
        },
        "authors": {
          "description": "List of document authors.",
          "type": "array",
          "items": { "$ref": "#/$defs/author" }
        },
        "created": {
          "description": "ISO-8601 calendar date when the document was created.",
          "type": "string",
          "format": "date"
        },
        "labels": {
          "description": "Keywords that describe the roadbook.",
          "type": "array",
          "items": { "type": "string" }
        },
        "units": {
          "description": "Measurement units used in the document.",
          "$ref": "#/$defs/units"
        },
        "extensions": {
          "description": "Optional vendor-specific extensions.",
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "stages": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/stage" }
    }
  },
  "$defs": {
    "author": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": true,
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "email": { "type": "string", "format": "email" },
        "role": { "type": "string" }
      }
    },
    "units": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "distance": {
          "type": "string",
          "enum": ["km", "mi", "m"]
        },
        "heading": {
          "type": "string",
          "enum": ["deg", "rad"]
        },
        "speed": {
          "type": "string",
          "enum": ["kmh", "mph", "ms"]
        }
      }
    },
    "stage": {
      "type": "object",
      "required": ["id", "name", "trunk"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "trunk": { "$ref": "#/$defs/route" },
        "branches": {
          "type": "array",
          "items": { "$ref": "#/$defs/branch" }
        }
      }
    },
    "route": {
      "type": "object",
      "required": ["instructions"],
      "additionalProperties": false,
      "properties": {
        "instructions": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/instruction" }
        }
      }
    },
    "branch": {
      "type": "object",
      "required": ["id", "instructions"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "name": { "type": "string" },
        "note": { "type": "string" },
        "continue_to": { "type": ["string", "null"], "description": "Optional instruction id to link to after the branch finishes (informational)." },
        "tulip": { "$ref": "#/$defs/tulip" },
        "instructions": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/instruction" }
        }
      }
    },
    "instruction": {
      "type": "object",
      "required": ["distance"],
      "additionalProperties": true,
      "properties": {
        "id": { "type": "string" },
        "distance": {
          "type": "number",
          "minimum": 0
        },
        "time_stage": {
          "type": "string",
          "pattern": "^PT"
        },
        "heading": {
          "type": "integer",
          "minimum": 0,
          "maximum": 359
        },
        "type": {
          "type": "string",
          "enum": [
            "start",
            "finish",
            "checkpoint",
            "milestone",
            "hazard",
            "service",
            "custom"
          ]
        },
        "tulip": { "$ref": "#/$defs/tulip" },
        "road": { "$ref": "#/$defs/road" },
        "location": { "$ref": "#/$defs/location" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        },
        "note": { "type": "string" },
        "alternatives": {
          "type": "array",
          "items": {
            "oneOf": [
              { "$ref": "#/ $defs/alternative_skip" },
              { "$ref": "#/ $defs/alternative_branch_ref" }
            ]
          },
          "description": "Informational list of alternatives starting at this instruction. Items can be skip entries or branch references."
        },
        "time": {
          "description": "Optional time constraint or hint. Can be a simple string (HH:MM or PT...) or an object with earliest/latest bounds.",
          "oneOf": [
            { "type": "string" },
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "earliest": { "type": "string", "description": "Earliest allowed time (PT... or HH:MM/T...)" },
                "latest": { "type": "string", "description": "Latest allowed time (PT... or HH:MM/T...)" }
              },
              "minProperties": 1
            }
          ]
        },
        "symbols": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "tulip": {
      "type": "object",
      "required": ["symbol"],
      "additionalProperties": true,
      "properties": {
        "symbol": { "type": "string", "minLength": 1 }
      }
    },
    "road": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "current": { "type": "string" },
        "next": { "type": "string" }
      }
    },
    "location": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "name": { "type": "string" },
        "coords": {
          "type": "array",
          "items": [
            { "type": "number", "minimum": -90, "maximum": 90 },
            { "type": "number", "minimum": -180, "maximum": 180 }
          ],
          "minItems": 2,
          "maxItems": 2
        },
        "plus": { "type": "string" },
        "w3w": { "type": "string" }
      }
    }
    ,
    "alternative_skip": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "skip_to": { "type": "string", "description": "Instruction id to jump to (navigation-only)." },
        "next_road": { "type": "string" },
        "tulip": { "$ref": "#/$defs/tulip" },
        "note": { "type": "string" }
      },
      "required": ["skip_to"]
    },
    "alternative_branch_ref": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "branch": { "type": "string", "description": "Reference a stage-level branch id." },
        "note": { "type": "string" }
      },
      "required": ["branch"]
    },
    "time_constraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["no-earlier-than", "no-later-than"] },
        "time": { "type": "string", "description": "Either an ISO8601 duration (PT...) relative to stage start or an ISO8601 time/date (T14:30 or full date-time)." }
      },
      "required": ["type", "time"]
    }
  }
}
